<html>
<head>
<meta charset="UTF-8">
<title>wallet</title>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1" crossorigin="anonymous">
<link rel="stylesheet" href="./css/detail.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-datepicker@1.9.0/dist/css/bootstrap-datepicker3.css" integrity="sha256-AghQEDQh6JXTN1iI/BatwbIHpJRKQcg2lay7DE5U/RQ=" crossorigin="anonymous">

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.bundle.min.js" integrity="sha384-ygbV9kiqUc6oa4msXn9868pTtWMgiQaeYH7/t7LECLbyPA2x65Kgf80OJFdroafW" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.min.js" integrity="sha384-pQQkAEnwaBkjpqZ8RU1fF1AKtTcHJwFl3pblpTlHXybJjHpMYo79HY3hIi4NKxyj" crossorigin="anonymous"></script>

<!-- datapicker -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap-datepicker@1.9.0/dist/js/bootstrap-datepicker.min.js" integrity="sha256-bqVeqGdJ7h/lYPq6xrPv/YGzMEb6dNxlfiTUHSgRCp8=" crossorigin="anonymous"></script>
<!-- datapicker 日本語化 -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap-datepicker@1.9.0/dist/locales/bootstrap-datepicker.ja.min.js" integrity="sha256-IX182a23hiQE65+kYOND1ZIX2Vpl0cHb96g9nJqqqW0=" crossorigin="anonymous"></script>

<script src="./js/api.js"></script>
</head>
<body class="text-center">
    <div class="mx-auto">
        <div class="card" style="width: 70rem;">
            <main class="main">
                  <div class="sub">
                    <h1 class="month"><input id="datepicker" type="text" /></h1>
                    <div class="sub-table">
                        <div class="members">
                            <div class="subtitle">
                                <h4>メンバー</h4>
                            </div>
                            <table class="table table-striped members">
                                <thead>
                                    <tr>
                                        <th scope="col">支払い</th>
                                        <th scope="col">合計</th>
                                    </tr>
                                </thead>
                                <tbody id="memberbody"></tbody>
                            </table>
                        </div><!-- members -->

                        <div class="categories">
                            <div class="subtitle">
                                <h4>項目</h4>
                            </div>
                            <table class="table table-striped categories">
                                <thead>
                                    <tr>
                                        <th scope="col">項目</th>
                                        <th scope="col">合計</th>
                                    </tr>
                                </thead>
                                <tbody id="categorybody"></tbody>
                            </table>
                        </div><!-- categories -->
                    </div>

                    <div class="total">
                        <table class="table table-striped total">
                            <thead>
                                <tr>
                                    <th scope="col">合計</th>
                                    <th scope="col" id="total-price"></th>
                                </tr>
                            </thead>
                        </table>
                    </div><!-- total -->
                    <a href="" class="btn btn-secondary" id="go-back">戻る</a>
                  </div><!-- sub -->
            </main>
        </div>
    </div>

    <script>
        // 月をセッションストレージから取得(再読み込み時)
        var month = sessionStorage.getItem('month');

        // datepickerの設定
        $('#datepicker').datepicker({
            language: "ja",
            format: "yyyy年mm月",
            minViewMode: 1,
            maxViewMode: 2,   
        });

        // datepickerの初期値を設定
        if (month == null){
            $("#datepicker").datepicker("setDate", "2014/02/15");
        } else {
            var yyyy = month.substring(0,4);
            var mm = month.substring(4,6);
            var yyyyMM = yyyy + "年" + mm + "月";
            $("#datepicker").datepicker("setDate", yyyyMM);
        }

        // 初期の値を取得
        var month = $("#datepicker").datepicker().val();
        month = month.replace(/年/g, '');
        month = month.replace(/月/g, '');
        sessionStorage.setItem('month', month);

        // 日付変更時の処理
        $('#datepicker').on({
              changeDate:
                function(obj) {
                  var yyyy = obj.date.getFullYear();
                  var mm = obj.date.getMonth() + 1;
                  month = String(yyyy) + String(mm);
                  sessionStorage.setItem('month', month);
                  window.location.reload();
                }
            });

        var groupId;
        const searchParams = new URLSearchParams(window.location.search)

        if (searchParams.has('id')){
            groupId = searchParams.get('id');
        } else {
            window.location.href = "error";
        }

        // hrefを書き換える
        let input = document.getElementById('go-back');
        input.setAttribute('href', "group?id=" + groupId);

        // 家計簿の小計・合計を取得する
        $.ajax({
                url: BASE_URL + `/expenses-total?groupid=${groupId}&month=${month}`,
                type: "GET",
                async: true,
                dataType: "json",
                contentType: "application/json",
                timeout: 5000,
                cache: false,
                success: function (responseData) {
                  // 成功時処理
                  var total = responseData.total;
                  var memberSubTotal = responseData.memberSubTotal;
                  var categorySubTotal = responseData.categorySubTotal;

                  // 合計を追加
                  $("#total-price").text(total + '円');

                  // 会員ごとの合計を追加
                  for (let i = 0; i < memberSubTotal.length; i++) {
                    $('#memberbody').append('<tr><td>' +memberSubTotal[i].name + '</td><td>'+ memberSubTotal[i].total + '</tr>');
                　}

                  // 項目ごとの合計を追加
                  for (let i = 0; i < categorySubTotal.length; i++) {
                    $('#categorybody').append('<tr><td>' +categorySubTotal[i].name + '</td><td>'+ categorySubTotal[i].total + '</tr>');
                　}
                },
                error: function  (xhr, textStatus, errorThrown) {
                  // 失敗時処理
                  window.location.href = "error";
                },
            });
      </script>
</body>
</html>